{% extends "base.html" %}

{% block title %}Dashboard - NutriTrack Pro{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .macro-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
    }
    .food-item {
        transition: background-color 0.2s;
    }
    .food-item:hover {
        background-color: var(--bg-tertiary);
    }
    .meal-section {
        margin-bottom: 2rem;
    }
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: var(--text-secondary);
    }
    .streak-badge {
        font-size: 2.5rem;
    }
    .quick-add-btn {
        transition: all 0.2s;
    }
    .quick-add-btn:hover {
        transform: scale(1.05);
    }
    /* Advanced Feature CSS */
    .health-indicator {
        height: 8px;
        border-radius: 4px;
        background: #30363d;
        overflow: hidden;
        display: flex;
    }
    /* Modal Styling */
    .modal-content {
        background-color: #161b22;
        border: 1px solid #30363d;
        color: #c9d1d9;
    }
    .macro-list-item {
        border-bottom: 1px solid #30363d;
        padding: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-lg-8">
            <h1 class="mb-1">Welcome back, {{ current_user.username }}! ðŸ‘‹</h1>
            <p class="text-muted">{{ now.strftime('%A, %B %d, %Y') }}</p>
        </div>
        <div class="col-lg-4 text-lg-end">
            <div class="d-inline-block">
                <div class="streak-badge">{{ streak_emoji }}</div>
                <small class="text-muted d-block">{{ current_user.current_streak }} day streak</small>
                <small class="text-success">{{ streak_text }}</small>
            </div>
        </div>
    </div>
    
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">CALORIES</small>
                        <i class="bi bi-fire text-danger"></i>
                    </div>
                    <h3 class="mb-1">{{ today_summary.calories|int }}</h3>
                    <small class="text-muted">of {{ current_user.daily_calorie_target }}</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar" role="progressbar" style="width: {{ calories_percentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">PROTEIN</small>
                        <i class="bi bi-egg-fill text-warning"></i>
                    </div>
                    <h3 class="mb-1">{{ today_summary.protein|int }}g</h3>
                    <small class="text-muted">of {{ current_user.protein_target }}g</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ protein_percentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">CARBS</small>
                        <i class="bi bi-droplet-fill text-info"></i>
                    </div>
                    <h3 class="mb-1">{{ today_summary.carbs|int }}g</h3>
                    <small class="text-muted">of {{ current_user.carbs_target }}g</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ carbs_percentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">FAT</small>
                        <i class="bi bi-square-fill" style="color: #9b59b6;"></i>
                    </div>
                    <h3 class="mb-1">{{ today_summary.fat|int }}g</h3>
                    <small class="text-muted">of {{ current_user.fat_target }}g</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar" style="background-color: #9b59b6; width: {{ fat_percentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-plus-circle-fill"></i> Log Food</span>
                </div>
                <div class="card-body">
                    <form id="foodLogForm">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <div style="position: relative;">
                                    <input type="text" class="form-control" id="foodSearch" placeholder="Search food..." autocomplete="off">
                                    <div id="searchResults" class="list-group mt-2" style="position: absolute; z-index: 1050; width: 100%; max-height: 400px; overflow-y: auto; display: none; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="quantity" placeholder="Qty" value="100" min="1">
                                    <select class="form-select" id="servingUnit" style="max-width: 90px; background-color: var(--bg-tertiary); color: white; border-color: var(--border-color);">
                                        <option value="g">g</option>
                                        <option value="ml">ml</option>
                                        <option value="pc">pc</option>
                                        <option value="bowl">bowl</option>
                                        <option value="cup">cup</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <select class="form-select" id="mealType">
                                        <option value="breakfast">Breakfast</option>
                                        <option value="lunch">Lunch</option>
                                        <option value="dinner">Dinner</option>
                                        <option value="snack">Snack</option>
                                    </select>
                                    <button type="submit" class="btn btn-primary">Add</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    {% if favorites %}
                    <div class="mt-3">
                        <small class="text-muted"><i class="bi bi-star-fill"></i> Favorites</small>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            {% for food in favorites[:5] %}
                            <button class="btn btn-sm btn-outline-secondary quick-add-btn" onclick="quickAddFood({{ food.id }}, '{{ food.name }}')">
                                {{ food.name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-journal-text"></i> Today's Food Diary
                </div>
                <div class="card-body">
                    {% if today_summary.meal_count == 0 %}
                    <div class="empty-state">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-3">No meals logged today</p>
                    </div>
                    {% else %}
                        {% for meal_key, meal_logs in meals.items() %}
                            {% if meal_logs %}
                            <div class="meal-section">
                                <h6 class="text-muted mb-3 text-capitalize"><i class="bi bi-clock"></i> {{ meal_key }}</h6>
                                {% for log in meal_logs %}
                                <div class="food-item d-flex justify-content-between align-items-center p-2 rounded mb-2">
                                    <div>
                                        <strong>{{ log.food.name }}</strong>
                                        <small class="text-muted d-block">{{ log.quantity|int }}g â€¢ {{ log.calories|int }} cal</small>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted d-block">P: {{ log.protein|int }}g â€¢ C: {{ log.carbs|int }}g â€¢ F: {{ log.fat|int }}g</small>
                                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteLog({{ log.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4 text-center">
                <div class="card-header text-start">Daily Summary</div>
                <div class="card-body">
                    <h2 class="{{ 'text-success' if remaining_calories >= 0 else 'text-danger' }}">
                        {{ remaining_calories|abs|int }}
                    </h2>
                    <small class="text-muted">{{ 'Remaining' if remaining_calories >= 0 else 'Over' }} Calories</small>
                </div>
            </div>

            <div class="card mb-4 border-primary border-opacity-25">
                <div class="card-header"><i class="bi bi-heart-pulse"></i> Health Status</div>
                <div class="card-body text-center">
                    {% if current_user.weight and current_user.height %}
                        <h4 class="mb-1 text-primary">{{ current_user.get_bmi() }}</h4>
                        <span class="badge {% if current_user.get_bmi() < 25 %}bg-success{% else %}bg-warning{% endif %} mb-3">
                            {{ "Healthy Weight" if current_user.get_bmi() < 25 else "Check Diet" }}
                        </span>
                        <div class="health-indicator mb-2">
                            <div class="bg-info" style="width: 25%"></div>
                            <div class="bg-success" style="width: 35%"></div>
                            <div class="bg-warning" style="width: 25%"></div>
                            <div class="bg-danger" style="width: 15%"></div>
                        </div>
                        <small class="text-muted d-block">BMI scale: 18.5 - 25 is Ideal</small>
                    {% else %}
                        <small class="text-muted">Update profile height/weight to see BMI</small>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">Weekly Trend</div>
                <div class="card-body"><canvas id="weeklyChart" height="150"></canvas></div>
            </div>

            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Nutrient Breakdown</span>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#macrosModal">
                        Macros
                    </button>
                </div>
                <div class="card-body" style="height: 250px;">
                    <canvas id="macroPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="macrosModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title">Today's Nutrition Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="macro-list">
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Protein</span> <strong>{{ today_summary.protein|round(1) }}g</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Carbohydrates</span> <strong>{{ today_summary.carbs|round(1) }}g</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Total Fats</span> <strong>{{ today_summary.fat|round(1) }}g</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Energy (Calories)</span> <strong>{{ today_summary.calories|int }} kcal</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Sodium</span> <strong>{{ today_summary.sodium_mg|int if today_summary.sodium_mg else 0 }}mg</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Cholesterol</span> <strong>{{ today_summary.cholesterol_mg|int if today_summary.cholesterol_mg else 0 }}mg</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Fiber</span> <strong>{{ today_summary.fibre_g|round(1) if today_summary.fibre_g else 0 }}g</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Vitamin C</span> <strong>{{ today_summary.vitc_mg|round(1) if today_summary.vitc_mg else 0 }}mg</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between">
                        <span>Vitamin A</span> <strong>{{ today_summary.vita_ug|int if today_summary.vita_ug else 0 }}Âµg</strong>
                    </div>
                    <div class="macro-list-item d-flex justify-content-between border-bottom-0">
                        <span>Iron</span> <strong>{{ today_summary.iron_mg|round(1) if today_summary.iron_mg else 0 }}mg</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="ai-chat-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: sans-serif;">
    
    <div id="chat-window" style="display: none; width: 350px; height: 450px; background: white; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; margin-bottom: 15px; border: 1px solid #ddd;">
        
        <div style="background: #28a745; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>ðŸ¤– Nutri Coach AI</span>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; cursor: pointer; font-size: 20px;">&times;</button>
        </div>
        
        <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column; gap: 10px;">
            <div style="align-self: flex-start; background: #e9ecef; padding: 10px; border-radius: 10px 10px 10px 0; max-width: 80%; color: #333; font-size: 14px;">
                Hello! Mai aapka personal AI Nutritionist hu. Aap mujhse diet, workout ya apni health ke baare mein kuch bhi puchiye! ðŸ¥—ðŸ’ª
            </div>
        </div>
        
        <div style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; background: white;">
            <input type="text" id="user-input" placeholder="Ask e.g. 'High protein veg snacks?'" 
                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 14px;">
            <button onclick="sendMessage()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold;">âž¤</button>
        </div>
    </div>

    <button onclick="toggleChat()" style="width: 60px; height: 60px; border-radius: 50%; background: #28a745; color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 30px; transition: transform 0.2s;">
        ðŸ’¬
    </button>
</div>

<script>
    function toggleChat() {
        const window = document.getElementById('chat-window');
        if (window.style.display === 'none') {
            window.style.display = 'flex';
        } else {
            window.style.display = 'none';
        }
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const messages = document.getElementById('chat-messages');
        const text = input.value.trim();
        
        if (!text) return;

        messages.innerHTML += `
            <div style="align-self: flex-end; background: #28a745; color: white; padding: 10px; border-radius: 10px 10px 0 10px; max-width: 80%; font-size: 14px;">
                ${text}
            </div>
        `;
        input.value = '';
        messages.scrollTop = messages.scrollHeight;

        const loadingId = 'loading-' + Date.now();
        messages.innerHTML += `
            <div id="${loadingId}" style="align-self: flex-start; background: #e9ecef; padding: 10px; border-radius: 10px 10px 10px 0; font-size: 12px; color: #666;">
                AI soch raha hai... ðŸ¤”
            </div>
        `;
        messages.scrollTop = messages.scrollHeight;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            
            const data = await response.json();
            document.getElementById(loadingId).remove();

            if (data.reply) {
                messages.innerHTML += `
                    <div style="align-self: flex-start; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 10px 10px 10px 0; max-width: 85%; font-size: 14px; color: #333;">
                        ${data.reply}
                    </div>
                `;
            } else {
                messages.innerHTML += `<div style="color: red; font-size: 12px; padding: 5px;">Error: ${data.error}</div>`;
            }
        } catch (err) {
            document.getElementById(loadingId).remove();
            messages.innerHTML += `<div style="color: red; font-size: 12px; padding: 5px;">Server connect nahi ho paya.</div>`;
        }
        messages.scrollTop = messages.scrollHeight;
    }

    document.getElementById('user-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Global variables
let selectedFoodId = null;
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('foodSearch');
    const searchResults = document.getElementById('searchResults');
    const logForm = document.getElementById('foodLogForm');

    // Search Logic
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        clearTimeout(searchTimeout);
        if (query.length < 2) { searchResults.style.display = 'none'; return; }

        searchTimeout = setTimeout(() => {
            fetch(`/api/search-food?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(foods => {
                    if (foods.length === 0) {
                        searchResults.innerHTML = '<div class="list-group-item">No foods found</div>';
                    } else {
                        searchResults.innerHTML = foods.map(food => `
                            <a href="#" class="list-group-item list-group-item-action" data-food-id="${food.id}" data-food-name="${food.name}">
                                <strong>${food.name}</strong> <small>(${Math.round(food.calories)} cal/100g)</small>
                            </a>
                        `).join('');
                    }
                    searchResults.style.display = 'block';

                    // Selection Logic with SMART UNIT logic
                    searchResults.querySelectorAll('.list-group-item-action').forEach(item => {
                        item.onclick = function(e) {
                            e.preventDefault();
                            selectedFoodId = this.dataset.foodId;
                            const foodName = this.dataset.foodName;
                            searchInput.value = foodName;
                            searchResults.style.display = 'none';

                            // SMART UNIT SELECTION DYNAMICS
                            const unitSelect = document.getElementById('servingUnit');
                            const qtyInput = document.getElementById('quantity');
                            const nameLower = foodName.toLowerCase();

                            if (nameLower.includes('rice') || nameLower.includes('dal') || nameLower.includes('poha') || nameLower.includes('sabzi')) {
                                unitSelect.value = 'bowl';
                                qtyInput.value = '1';
                            } else if (nameLower.includes('roti') || nameLower.includes('egg') || nameLower.includes('idli') || nameLower.includes('banana') || nameLower.includes('apple')) {
                                unitSelect.value = 'pc';
                                qtyInput.value = '1';
                            } else if (nameLower.includes('milk') || nameLower.includes('tea') || nameLower.includes('coffee') || nameLower.includes('juice')) {
                                unitSelect.value = 'cup';
                                qtyInput.value = '1';
                            } else {
                                unitSelect.value = 'g';
                                qtyInput.value = '100';
                            }
                        };
                    });
                });
        }, 300);
    });

    // Form Submit
    logForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!selectedFoodId) { alert('Select food first'); return; }

        const payload = {
            food_id: selectedFoodId,
            quantity: parseFloat(document.getElementById('quantity').value),
            unit: document.getElementById('servingUnit').value,
            meal_type: document.getElementById('mealType').value
        };

        fetch('/api/log-food', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if (data.success) window.location.reload();
        });
    });

    // Advanced: Macro Breakdown Chart
    const pieCtx = document.getElementById('macroPieChart');
    if (pieCtx && {{ today_summary.meal_count }} > 0) {
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['Protein', 'Carbs', 'Fat'],
                datasets: [{
                    data: [{{ today_summary.protein }}, {{ today_summary.carbs }}, {{ today_summary.fat }}],
                    backgroundColor: ['#ffc107', '#0dcaf0', '#9b59b6'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#8b949e' } }
                },
                cutout: '70%'
            }
        });
    }
});

function deleteLog(logId) {
    if (confirm('Delete this entry?')) {
        fetch(`/api/delete-log/${logId}`, { method: 'DELETE' }).then(() => window.location.reload());
    }
}

// Chart Logic (Weekly Trend)
const weeklyData = {{ weekly_data|tojson }};
const ctx = document.getElementById('weeklyChart');
if (ctx && weeklyData) {
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: weeklyData.map(d => d.date),
            datasets: [{
                label: 'Calories',
                data: weeklyData.map(d => d.calories),
                borderColor: '#238636',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(35, 134, 54, 0.1)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}
</script>
{% endblock %}